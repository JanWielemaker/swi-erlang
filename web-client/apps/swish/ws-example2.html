<html lang="en">
 <head>
  <script type="text/x-prolog">
   echo :-
       pengine_input('Write something and I will echo it!', X),
       (   X == null
       ->  true
       ;   pengine_output(X),
           echo
       ).
  </script>
 </head>
 <body>
  <script>
   function source() {
       var scripts = document.getElementsByTagName('script');
       var src = "";
       for (var i = 0; i < scripts.length; i++) {
           if (scripts[i].getAttribute('type') == 'text/x-prolog') {
               src += '\n' + scripts[i].textContent;
           }
       }
       return src.replace(/'/g,"\\'");;
   }
   var pid;
   ws = new WebSocket('ws://localhost:3051/chat');
   ws.onerror = function(message) {
       console.log(JSON.stringify(message));
   };
   ws.onopen = function(message) {
       console.log(JSON.stringify(message));
       ws.send("pengine_spawn([format('json-s'),src_text('"+source()+"')])");
   };
   ws.onmessage = function(message) {
       var event = JSON.parse(message.data);
       if (event.type == "create") {
           pid = event.pid;
           ws.send("pengine_ask('" + pid + "', echo)");
       } else if (event.type == "prompt") {
           var result = prompt(event.data);
           ws.send("pengine_respond('"+pid+"','"+result+"')");
       } else if (event.type == "output") {
           alert(event.data);
       }
   };
  </script>
 </body>
</html>

